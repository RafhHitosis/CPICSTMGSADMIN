<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/x-icon" href="assets/img/logo_.png">
	<link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
	<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="assets/css/style.css">
	<title>Student Completion Form</title>
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
	<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
	<style>
		body {
			font-family: 'Open Sans', sans-serif;
		}

		table {
			width: 100%;
			border-collapse: collapse;
		}

		th,
		td {
			padding: 10px;
			text-align: left;
		}

		#withdrawnTable tbody tr:nth-child(even) {
			background-color: gainsboro;
			/* Adjust color as needed */
		}

		.loadBtn {
			padding: 5px;
			border-radius: 6px;
			border: none;
			color: white;
			cursor: pointer;
			background-color: #4CAF50;
		}
		/* File Upload Dialog */
.file-upload-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    background-color: #fff;
    border: 1px solid #ddd;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 20px;
    z-index: 1000;
    display: none;
    border-radius: 10px;
}

.file-upload-dialog.show {
    display: block;
}

.file-upload-dialog.hide {
    display: none;
}

.file-upload-content {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.file-upload-content h2 {
    margin-bottom: 20px;
    font-size: 20px;
}

.file-upload-content input[type="file"] {
    margin-bottom: 20px;
}

#uploadStatus {
    margin-top: 10px;
    color: green;
}
	</style>
</head>

<body>

	<!-- SIDEBAR -->
	<section id="sidebar">
		<a href="#" class="brand"><img src="assets/img/logo_.png" style="height: 40px; width: 30px; margin-left: 10px;">
			&nbsp;&nbsp;&nbsp;Admin</a>
		<ul class="side-menu">
			<li><a href="Dashboard.html"><i class='bx bxs-dashboard icon'></i> Dashboard</a></li>
			<li class="divider" data-text="main">Main</li>
			<li><a href="setDuration.html"><i class='bx bxs-time icon'></i> Set Duration</a></li>
			<li><a href="subjects.html"><i class='bx bxs-book icon'></i> Subjects</a></li>
			<li><a href="grades.html"><i class='bx bxs-pen icon'></i> Grades</a></li>
			<li>
				<a href="#"><i class='bx bxs-user-detail icon'></i> User Accounts <i
						class='bx bx-chevron-right icon-right'></i></a>
				<ul class="side-dropdown">
					<li><a href="instructors.html"><i class='bx bxs-briefcase'></i>&nbsp;&nbsp;&nbsp;Instructor</a></li>
					<li><a href="students.html"><i class='bx bxs-bus'></i>&nbsp;&nbsp;&nbsp;Students</a></li>
				</ul>
			</li>
			<li class="divider" data-text="Reports">Reports</li>
			<li>
				<a href="#" class="active"><i class='bx bxs-notepad icon'></i> Grades Summary <i
						class='bx bx-chevron-right icon-right'></i></a>
				<ul class="side-dropdown">
					<li><a href="dropOuts.html"><i class='bx bxs-detail'></i>&nbsp;&nbsp;&nbsp;Drop-outs</a></li>
					<li><a href="studentCompletionForm.html"><i class='bx bxs-receipt'></i>&nbsp;&nbsp;&nbsp;Completion Form</a></li>
					<li><a href="studentDeficiency.html"><i class='bx bxs-report'></i>&nbsp;&nbsp;&nbsp;Student Deficiency</a></li>
					<li><a href="RTSemestralGrade.html"><i class='bx bxs-pencil'></i>&nbsp;&nbsp;&nbsp;Semestral
							Grades</a></li>
					<!-- <li><a href="#">Checkbox</a></li>
					<li><a href="#">Radio</a></li> -->
				</ul>
			</li>
			<li><a href="#" id="uploadFilesButton"><i class='bx bxs-file icon'></i> Upload Files</a></li>
		</ul>
	</section>
	<!-- SIDEBAR -->

	<!-- NAVBAR -->
	<section id="content">
		<!-- NAVBAR -->
		<nav>
			<i class='bx bx-menu toggle-sidebar'></i>
			<form action="#">
				<div class="form-group">
					<!-- <input type="text" placeholder="Search...">
					<i class='bx bx-search icon'></i> -->
				</div>
			</form>
			<a href="#" class="nav-link notification-bell">
				<i class='bx bxs-bell icon'></i>
				<span class="badge"></span>
			</a>
			<div class="dropdown-menu notifications-dropdown hide">
				<h4>Instructor Requests</h4>
				<ul id="requestList">
					<!-- Instructor request categories will be populated here -->
				</ul>
			</div>	
			<!-- <a href="#" class="nav-link">
				<i class='bx bxs-message-square-dots icon'></i>
				<span class="badge">8</span>
			</a> -->
			<span class="divider"></span>
			<div class="profile">
				<img src="https://images.unsplash.com/photo-1517841905240-472988babdf9?ixid=MnwxMjA3fDB8MHxzZWFyY2h8NHx8cGVvcGxlfGVufDB8fDB8fA%3D%3D&ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60"
					alt="">
				<ul class="profile-link">
					<li><a href="changePassword.html"><i class='bx bxs-cog'></i> Change Password</a></li>
					<li><a href="#" onclick="logout()"><i class='bx bxs-log-out-circle'></i> Logout</a></li>
				</ul>
			</div>
		</nav>
		<!-- NAVBAR -->

		<!-- MAIN -->
		<main>
			<h1 class="title">Student Completion Form</h1>
			<ul class="breadcrumbs">
				<li><a href="#">Grades Summary</a></li>
				<li class="divider">/</li>
				<li><a href="#" class="active">Student Completion Form</a></li>
			</ul>

			<br>

			<label for="semesterSelect">Select Semester:</label>
<select id="semesterSelect" style="margin-bottom: 14px; margin-right: 20px;">
	<option value="">--Select Semester--</option>
	<option value="1stsem">First Semester</option>
	<option value="2ndsem">Second Semester</option>
	<option value="summer">Summer</option>
	<option value="midyear">Mid Year Term</option>
	<!-- Add more semesters as needed -->
</select>

<label for="yearSelect">Select Academic Year:</label>
<select id="yearSelect" style="margin-bottom: 14px;">
	<option value="">--Select Academic Year--</option>
	<option value="2425">2024-2025</option>
	<option value="2324">2023-2024</option>
	<!-- Add more academic years as needed -->
</select>

			<button id="loadDataBtn" class="loadBtn">Load Data</button>

			<div class="content-data">
				<table id="withdrawnTable" style="width:100%" class="display nowrap">
					<thead>
						<tr>
							<th>Student Name</th>
							<th>Subject Code</th>
							<th>Description</th>
							<th>ID</th>
							<th>Possible Grade</th>
							<th>Deficiency Requirements</th>
							<th>Remarks</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>


																			<!-- File Upload Dialog -->
<div id="fileUploadDialog" class="file-upload-dialog hide">
    <div class="file-upload-content">
        <h2>Upload File</h2>
        <form id="fileUploadForm">
            <input type="file" id="fileInput" />
            <button type="button" id="uploadButton">Upload</button>
            <button type="button" id="closeDialogButton">Close</button>
        </form>
        <div id="uploadStatus"></div> <!-- For displaying upload status -->
    </div>
</div>

		</main>
		<!-- MAIN -->
	</section>
	<!-- NAVBAR -->

	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
	<!-- DataTables JS -->
	<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
	<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
		import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

		// Firebase configuration
		const firebaseConfig = {
			apiKey: "AIzaSyAgplxh789FO-NDxHmKA49ro71tjYBU-JE",
			authDomain: "icstmgsdb.firebaseapp.com",
			databaseURL: "https://icstmgsdb-default-rtdb.firebaseio.com",
			projectId: "icstmgsdb",
			storageBucket: "icstmgsdb.appspot.com",
			messagingSenderId: "619240877167",
			appId: "1:619240877167:web:9402346b3d9e6e1f57b19a"
		};

		// Initialize Firebase
		const app = initializeApp(firebaseConfig);
		const database = getDatabase(app);

		// Function to populate the academic year/semester dropdown
		const populateGradeSelect = () => {
			const gradeSelect = document.getElementById('gradeSelect'); // Fix: reference to gradeSelect
			const gradesRef = ref(database, 'grades');

			get(gradesRef).then(snapshot => {
				if (snapshot.exists()) {
					const gradesData = snapshot.val();
					for (let gradeKey in gradesData) {
						const option = document.createElement('option');
						option.value = gradeKey;
						option.textContent = gradeKey;
						gradeSelect.appendChild(option);
					}
				}
			}).catch(error => {
				console.error('Error fetching grades:', error);
			});
		};

		// Call the function to populate the dropdown on page load
		populateGradeSelect();

		const loadData = () => {
    const selectedSemester = document.getElementById('semesterSelect').value;
    const selectedYear = document.getElementById('yearSelect').value;

    // Validate dropdown selections
    if (!selectedSemester || !selectedYear) {
        alert("Please select both the semester and the academic year.");
        return;
    }

    // Construct the database path based on the selected semester and academic year
    const selectedGradeNode = `grade${selectedYear}_${selectedSemester}`;

    const tableBody = document.querySelector('#withdrawnTable tbody');
    tableBody.innerHTML = '';

    const gradesRef = ref(database, `grades/${selectedGradeNode}/data`);
    const subjectsRef = ref(database, 'subjects');
    const studentsRef = ref(database, 'studentInfo/data');
    const studentAcctRef = ref(database, 'studentacct/data');

    Promise.all([
        get(gradesRef),
        get(subjectsRef),
        get(studentsRef),
        get(studentAcctRef)
    ]).then(([gradesSnapshot, subjectsSnapshot, studentsSnapshot, studentAcctSnapshot]) => {
        if (gradesSnapshot.exists() && studentAcctSnapshot.exists()) {
            const gradesData = gradesSnapshot.val();
            const subjectsData = subjectsSnapshot.val();
            const studentsInfo = studentsSnapshot.val();
            const studentAcctInfo = studentAcctSnapshot.val();

            // Loop through each grade entry
            Object.values(gradesData).forEach(gradeEntry => {
                const studentAcct = Object.values(studentAcctInfo).find(acct => acct.StudNum === gradeEntry.studnum);

                if (studentAcct && studentAcct.Clearance === 'No' && gradeEntry.remarks === 'INCOMPLETE') {
                    // Find the correct subject data
                    let subjectCode = 'N/A';
                    let subjectDescription = 'N/A';
                    for (const semesterKey in subjectsData) {
                        const semesterSubjects = subjectsData[semesterKey];
                        for (const subjCode in semesterSubjects) {
                            if (semesterSubjects[subjCode].id === gradeEntry.id) {
                                subjectCode = subjCode;
                                subjectDescription = semesterSubjects[subjCode].description;
                                break;
                            }
                        }
                        if (subjectCode !== 'N/A') break;
                    }

                    // Get student name from the studentInfo structure
                    const studentInfo = Object.values(studentsInfo).find(info => info.StudNum === gradeEntry.studnum);
                    const studentName = studentInfo ? `${studentInfo.Fname} ${studentInfo.Mname} ${studentInfo.Lname}` : 'Unknown Student';

                    // Get possible grade from the gradeEntry
                    const possibleGrade = gradeEntry.possiblegrade || 'N/A';

                    // Insert the row in the table with the student's data
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${studentName}</td>
                        <td>${subjectCode}</td>
                        <td>${subjectDescription}</td>
                        <td>${gradeEntry.id}</td>
                        <td>${possibleGrade}</td>
                        <td>NC/P</td>
                        <td>${gradeEntry.remarks}</td>
                    `;
                    tableBody.appendChild(row);
                }
            });

            // Initialize DataTable with export options
            $(document).ready(function () {
                $('#withdrawnTable').DataTable({
                    "scrollX": true,
                    "scrollY": 300,
                    dom: 'Bfrtip',
                    buttons: [
                        {
                            extend: 'excelHtml5',
                            text: 'Export to Excel',
                            title: 'Student Completion Form'
                        },
                        {
                            extend: 'pdfHtml5',
                            text: 'Export to PDF',
                            title: 'Student Completion Form'
                        },
                        {
                            extend: 'print',
                            text: 'Print',
                            title: 'Student Completion Form'
                        },
                        {
                            text: 'Export to Word',
                            action: function (e, dt, node, config) {
                                Export2Word('withdrawnTable', 'Student_Completion_Form');
                            }
                        }
                    ]
                });
            });

        } else {
            alert('No data available for the selected academic year/semester or student accounts.');
        }

    }).catch(error => {
        console.error('Error fetching data:', error);
    });
};


		document.getElementById('loadDataBtn').addEventListener('click', loadData);

		// Logout function
		const logout = () => {
			// Implement logout logic
			alert('Logout successful!'); // Placeholder for logout logic
		};
	</script>
	<script>
		// Get logged-in username from localStorage
		const username = localStorage.getItem('username');
		if (!username) {
			window.location.href = 'login.html';  // Redirect to login if not logged in
		}
		function logout() {
			localStorage.removeItem('isLoggedIn');
			localStorage.removeItem('username');
			window.location.href = 'login.html';
		}
	</script>
	<script>
		// Function to export to Word with header and aligned table content, including Google Drive image
		function Export2Word(element, filename = '') {
			// Google Drive image URL with the formatted direct link
			var googleDriveImageURL = 'https://drive.google.com/uc?export=view&id=1veEIZx0RZZK0DGNI8Sq5HP2hidQukum_'; // Updated with your new link
	
			// Define styles and include a header with an image from Google Drive
			var preHtml = `
				<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
					<head>
						<meta charset='utf-8'>
						<title>Export HTML To Doc</title>
						<style>
							body {
								font-family: 'Open Sans', sans-serif;
							}
							.header {
								text-align: center;
								margin-bottom: 20px;
							}
							.header img {
								width: 80px; /* Adjust image width */
								height: auto; /* Maintain aspect ratio */
								margin-bottom: 10px; /* Add some spacing below the image */
							}
							.header h1 {
								font-size: 24px;
								margin: 10px 0;
							}
							table {
								width: 100%;
								border-collapse: collapse;
								margin-top: 20px;
							}
							th, td {
								border: 1px solid #ddd;
								padding: 8px;
								text-align: center; /* Center align table data */
							}
							th {
								background-color: #4CAF50;
								color: white;
								text-align: center; /* Center align table headers */
							}
							tr:nth-child(even) {
								background-color: #f2f2f2; /* Alternate row colors */
							}
							tr:hover {
								background-color: #ddd; /* Highlight row on hover */
							}
						</style>
					</head>
					<body>
						<div class="header">
							<img src="${googleDriveImageURL}" alt="Header Image">
							<h1>Student Completion Form</h1>
							<p>Semester</p>
							<p>Academic Year</p>
						</div>`;
	
			var postHtml = "</body></html>";
	
			// Include table content from specified element
			var html = preHtml + document.getElementById(element).outerHTML + postHtml;
	
			// Create a Blob object to represent the content for Word document
			var blob = new Blob(['\ufeff', html], {
				type: 'application/msword'
			});
	
			// Specify the link URL
			var url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(html);
	
			// Specify the file name
			filename = filename ? filename + '.doc' : 'document.doc';
	
			// Create a download link element
			var downloadLink = document.createElement("a");
	
			document.body.appendChild(downloadLink);
	
			// If on Internet Explorer or Edge, use msSaveOrOpenBlob to download the file
			if (navigator.msSaveOrOpenBlob) {
				navigator.msSaveOrOpenBlob(blob, filename);
			} else {
				// Create a link to the file
				downloadLink.href = url;
	
				// Setting the file name
				downloadLink.download = filename;
	
				// Triggering the download
				downloadLink.click();
			}
	
			document.body.removeChild(downloadLink);
		}
	</script>	
	<script type="module" src="assets/js/upload.js"></script>
	<script src="assets/js/script.js"></script>
</body>

</html>